<?xml version="1.0" encoding="UTF-8"?>
<project
  name="checkForPromotion"
  default="checkForPromotion"
  basedir=".">


  <target
    name="checkForPromotion"
    depends="init"
    description="Check if it is time for a promotion to be triggered.">

    <retry
      retrycount="3"
      retrydelay="1000">
      <get
        ignoreerrors="true"
        verbose="true"
        src="${hudsonResultURL}"
        dest="${tmpzipdir}/archive.zip" />
    </retry>

    <retry
      retrycount="3"
      retrydelay="1000">
      <get
        src="${hudsonTestResultsURL}"
        dest="${resultsDir}/${job}-${buildNumber}.xml" />
    </retry>

    <unzip
      overwrite="true"
      src="${tmpzipdir}/archive.zip"
      dest="${resultsDir}/">
      <globmapper
        from="archive/workarea/${buildId}/eclipse-testing/results/*"
        to="*" />
    </unzip>


  </target>

  <target
    name="init"
    unless="checkForPromotionInitialized">

    <property environment="env" />
    <echo message="env.BUILD_HOME: ${env.BUILD_HOME}" />

    <!-- we set these "env" variables here not to effect the
           environment, but that because we need some value for them,
           so if not actually set in the environment, we create these
           with some reasonable default. (Though, if not set in the environment,
           could be a sign that somethign is not as expected?)
     -->
    <property
      name="env.HUDSON_HOST"
      value="hudson.eclipse.org" />
    <property
      name="env.HUDSON_PROTOCOL"
      value="https" />

    <property
      name="hudsonResultRootJobURL"
      value="${env.HUDSON_PROTOCOL}://${env.HUDSON_HOST}/hudson/job/" />

      <!-- should be passed in by caller, but by default we'll assign to latest -->
    <property
      name="release"
      value="mars" />

    <property
      name="timeFormat"
      value="yyyy-MM-dd'T'HH:mm:ss.SSSZ" />

    <property
      name="hudsonLatestBuildURL"
      value="${hudsonResultRootJobURL}/simrel.${release}.runaggregator/lastSuccessfulBuild/buildTimestamp?format=${timeFormat}" />

      <property
      name="hudsonLatestPropoteURL"
      value="${hudsonResultRootURL}/simrel.${release}.lockForPromotion/lastSuccessfulBuild/buildTimestamp?format=${timeFormat}" />

    <property
      name="checkForPromotionInitialized"
      value="true" />

  </target>

</project>